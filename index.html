<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Stock Portfolio Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #e0e7ff 100%);
            transition: background 0.3s, color 0.3s;
        }

        .metric-card {
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.13);
        }

        .positive {
            background: #d1fae5;
            color: #065f46;
        }

        .negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .dark-mode {
            background: linear-gradient(135deg, #18181b 0%, #312e81 100%) !important;
            color: #e0e7ef !important;
        }

        .dark-mode .metric-card,
        .dark-mode .bg-white {
            background: #232946 !important;
            color: #e0e7ef !important;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.25);
        }

        .dark-mode .positive {
            background: #134e4a !important;
            color: #6ee7b7 !important;
        }

        .dark-mode .negative {
            background: #7f1d1d !important;
            color: #fecaca !important;
        }

        .dark-mode table {
            background: #18181b !important;
            color: #e0e7ef !important;
        }

        .dark-mode th,
        .dark-mode td {
            border-color: #232946 !important;
        }

        .dark-mode .bg-gray-100,
        .dark-mode .bg-gray-50 {
            background: #232946 !important;
        }

        .dark-mode .text-gray-500,
        .dark-mode .text-gray-600,
        .dark-mode .text-gray-700 {
            color: #a5b4fc !important;
        }

        .dark-mode .text-blue-700 {
            color: #60a5fa !important;
        }

        .dark-mode .text-green-700 {
            color: #6ee7b7 !important;
        }

        .dark-mode .text-red-700 {
            color: #fecaca !important;
        }

        .dark-mode .text-blue-600 {
            color: #818cf8 !important;
        }

        .dark-mode .shadow {
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.35) !important;
        }

        .dark-toggle {
            cursor: pointer;
            background: #fff;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s, color 0.2s;
        }

        .dark-toggle:hover {
            background: #e0e7ff;
        }

        .dark-mode .dark-toggle {
            background: #232946;
            color: #e0e7ef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        }

        .fade-in {
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 10;
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .metric-card:hover .tooltip {
            display: block;
        }

        .dark-mode .tooltip {
            background: #232946;
            color: #e0e7ef;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .tooltip ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }

        .stock-tooltip {
            display: none;
            position: absolute;
            background: #fff;
            color: #1f2937;
            padding: 0.5rem;
            border-radius: 0.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            font-size: 0.85rem;
            width: 200px;
        }

        .symbol-cell:hover .stock-tooltip {
            display: block;
        }

        .dark-mode .stock-tooltip {
            background: #232946;
            color: #e0e7ef;
        }

        canvas.price-range-chart {
            height: 40px !important;
            width: 150px !important;
            margin: 0 auto;
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between fade-in"
            style="background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%); border-radius: 1rem; padding: 1.5rem 2rem; box-shadow: 0 4px 24px rgba(99,102,241,0.13);">
            <div class="flex flex-col gap-2 md:gap-0 md:flex-row md:items-center">
                <h1 class="text-3xl font-bold mb-2 md:mb-0 text-white flex items-center gap-2">
                    <span>ðŸ“ˆ</span> My Stock Portfolio Dashboard
                </h1>
                <span class="ml-3 text-lg font-semibold text-blue-100 flex items-center gap-2">
                    <svg class="w-6 h-6 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="10" />
                    </svg>
                    Viom Kapur
                </span>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <a href="https://kyupralis24.github.io/portfolio/" target="_blank"
                    class="transition-all duration-200 bg-white text-indigo-700 font-bold px-5 py-2 rounded-full shadow hover:bg-indigo-600 hover:text-white flex items-center gap-2 border-2 border-indigo-200 hover:border-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                    title="View my Resume Portfolio">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                    Resume Portfolio
                </a>
                <a href="https://www.linkedin.com/in/viom-kapur-93434621b/" target="_blank"
                    class="text-blue-100 hover:underline font-semibold">LinkedIn</a>
                <button id="darkModeToggle" class="dark-toggle" title="Toggle dark mode">
                    <svg id="darkIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m8.66-13.66l-.71.71M4.05 19.07l-.71.71M21 12h-1M4 12H3m16.66 5.66l-.71-.71M4.05 4.93l-.71-.71M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="lightIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" />
                    </svg>
                </button>
            </div>
        </header>
        <div class="mb-8 text-center fade-in">
            <p class="text-lg text-indigo-900 dark:text-indigo-200 font-medium">Welcome to Viom Kapur's personalized
                investment dashboard. Track, analyze, and grow your portfolio with confidence! ðŸš€</p>
        </div>

        <!-- Top Metrics -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="topMetrics">
            <!-- JS will populate -->
        </section>

        <!-- Insights -->
        <section class="mb-8" id="insights">
            <!-- JS will populate -->
        </section>

        <!-- Risk Metrics -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="riskMetrics">
            <!-- JS will populate -->
        </section>

        <!-- Investments Table with Screener -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">All Investments</h2>
                <div class="mb-4 flex flex-col md:flex-row gap-4">
                    <div>
                        <label for="sectorFilter" class="text-gray-600 mr-2">Filter by Sector:</label>
                        <select id="sectorFilter" class="border rounded p-2 text-gray-700">
                            <option value="">All Sectors</option>
                            <!-- JS will populate -->
                        </select>
                    </div>
                    <button id="sortProfitLoss" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        Sort by Profit/Loss (Asc)
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm" id="investmentsTable">
                        <!-- JS will populate -->
                    </table>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Stock Performance</h2>
                <canvas id="stockPerformanceChart" height="200"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Sector Allocation</h2>
                <canvas id="sectorChart" height="200"></canvas>
            </div>
        </section>

        <!-- Strategy -->
        <section class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-lg font-semibold mb-2">My Investment Strategy</h2>
            <p class="text-gray-600">I focus on data-driven, diversified, and long-term investments in the Indian
                market, prioritizing strong fundamentals and sectoral trends. I regularly review my portfolio for risk
                and growth opportunities.</p>
        </section>

        <!-- Stock Analysis Insights (React Component) -->
        <section class="mb-8" id="stockAnalysisSection">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Stock Analysis Insights</h2>
                <div id="stockAnalysisReact" class="overflow-x-auto"></div>
            </div>
        </section>

        <!-- Understanding the Metrics -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Understanding the Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">P/E Ratio</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> Provided directly from the "Stock Details" sheet.<br>
                            <strong>Explanation:</strong> The Price-to-Earnings (P/E) ratio measures a stock's price
                            relative to its earnings per share (EPS). A lower P/E may indicate an undervalued stock,
                            while a higher P/E could suggest growth expectations or overvaluation.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Volume Trend</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> Volume / Average Volume (assumed 100,000).<br>
                            - High Activity: > 1.5<br>
                            - Low Activity: < 0.5<br>
                                - Normal Activity: Otherwise<br>
                                <strong>Explanation:</strong> Compares the stock's trading volume to an assumed average.
                                High volume may indicate strong interest or news, while low volume suggests lack of
                                interest.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Change from High 52 (%)</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> (High 52 - Price) / High 52 Ã— 100%.<br>
                            <strong>Explanation:</strong> Shows how far the current price is below the 52-week high, as
                            a percentage. A smaller percentage indicates the stock is closer to its yearly peak,
                            suggesting potential resistance.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Change from Low 52 (%)</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> (Price - Low 52) / Low 52 Ã— 100%.<br>
                            <strong>Explanation:</strong> Shows how far the current price is above the 52-week low, as a
                            percentage. A larger percentage indicates the stock has risen significantly from its yearly
                            low, suggesting potential support.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Daily Change (â‚¹)</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> Provided directly from the "Stock Details" sheet (Change = Price -
                            Close Yesterday).<br>
                            <strong>Explanation:</strong> The absolute change in the stock's price from the previous
                            day's close. Positive values indicate a price increase, while negative values indicate a
                            decrease.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Daily Change (%)</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> Provided directly from the "Stock Details" sheet.<br>
                            <strong>Explanation:</strong> The percentage change in the stock's price from the previous
                            day's close. It helps assess the stock's daily performance relative to its price.
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">Price Range (52-Week)</h3>
                        <p class="text-gray-600">
                            <strong>Formula:</strong> Visual representation using Low 52, Price, and High 52.<br>
                            <strong>Explanation:</strong> A line chart showing the stock's price range over the past 52
                            weeks. The blue line spans from the 52-week low to high, with a red triangle indicating the
                            current price. Hover to see exact values.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script type="text/babel">
        // Google Sheets App Script endpoint
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxjoZEF_pqjuAL59l-3bAH2E2VD2eLi2IP6EHD34gQkYFmK5J5h8cRgDlSxeHLOIynPsA/exec';

        // Utility Functions
        function formatINR(num) {
            return 'â‚¹' + Number(num).toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function getPLClass(val) {
            return parseFloat(val) >= 0 ? 'positive' : 'negative';
        }

        // Price Range Chart Component (Using Chart.js Bar Chart)
        const PriceRangeChart = ({ low52, price, high52, index }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');
                const range = high52 - low52;
                const pricePosition = range !== 0 ? (price - low52) / range * 100 : 0;

                // Calculate rating (1-5)
                const rating = Math.min(5, Math.max(1, (pricePosition / 100) * 5));
                const fullIcons = Math.floor(rating);
                const hasHalfIcon = rating % 1 >= 0.5;

                // Get the current theme colors
                const isDarkMode = document.body.classList.contains('dark-mode');
                const activeColor = isDarkMode ? '#818cf8' : '#60a5fa';
                const inactiveColor = isDarkMode ? '#4b5563' : '#e5e7eb';

                // Clear canvas
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // Draw rating
                const barWidth = 40;
                const barHeight = 8;
                const spacing = 8;
                const totalWidth = (barWidth + spacing) * 5 - spacing;
                const startX = (ctx.canvas.width - totalWidth) / 2;
                const centerY = ctx.canvas.height / 2;

                // Draw background bars
                for (let i = 0; i < 5; i++) {
                    const x = startX + i * (barWidth + spacing);

                    // Draw rounded rectangle
                    ctx.beginPath();
                    ctx.roundRect(x, centerY - barHeight / 2, barWidth, barHeight, 4);
                    ctx.fillStyle = inactiveColor;
                    ctx.fill();

                    // Draw active portion
                    if (i < fullIcons) {
                        ctx.beginPath();
                        ctx.roundRect(x, centerY - barHeight / 2, barWidth, barHeight, 4);
                        ctx.fillStyle = activeColor;
                        ctx.fill();
                    } else if (i === fullIcons && hasHalfIcon) {
                        ctx.beginPath();
                        ctx.roundRect(x, centerY - barHeight / 2, barWidth / 2, barHeight, 4);
                        ctx.fillStyle = activeColor;
                        ctx.fill();
                    }
                }

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                };
            }, [low52, price, high52]);

            return <canvas ref={chartRef} className="price-range-chart"></canvas>;
        };

        // Stock Analysis Component
        const StockAnalysis = ({ data }) => {
            return (
                <div>
                    <table className="min-w-full text-sm">
                        <thead>
                            <tr className="bg-gray-100">
                                <th className="p-2">Symbol</th>
                                <th className="p-2">P/E Ratio</th>
                                <th className="p-2">Volume Trend</th>
                                <th className="p-2">Change from High 52 (%)</th>
                                <th className="p-2">Change from Low 52 (%)</th>
                                <th className="p-2">Daily Change (â‚¹)</th>
                                <th className="p-2">Daily Change (%)</th>
                                <th className="p-2">Price Range (52-Week)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => {
                                const pe = parseFloat(item['P/E']) || 0;
                                const volume = parseFloat(item.Volume) || 0;
                                const change = parseFloat(item.Change) || 0;
                                const changePct = parseFloat(item['Change %']) || 0;
                                const price = parseFloat(item.Price) || 0;
                                const high52 = parseFloat(item['High 52']) || 0;
                                const low52 = parseFloat(item['Low 52']) || 0;

                                // Volume Trend
                                const avgVolume = 100000;
                                const volumeRatio = volume / avgVolume;
                                let volumeTrend = 'Normal Activity';
                                if (volumeRatio > 1.5) volumeTrend = 'High Activity';
                                else if (volumeRatio < 0.5) volumeTrend = 'Low Activity';

                                // Change from High 52 and Low 52
                                const distHigh = high52 !== 0 ? (((high52 - price) / high52) * 100).toFixed(2) : 'N/A';
                                const distLow = low52 !== 0 ? (((price - low52) / low52) * 100).toFixed(2) : 'N/A';

                                // Quick Insights for Tooltip
                                const insights = [];
                                if (pe !== 0 && pe < 15) insights.push('Low P/E: Potentially undervalued');
                                if (pe !== 0 && pe > 25) insights.push('High P/E: High growth expectations');
                                if (volumeRatio > 1.5) insights.push('High trading activity: Possible news or interest');
                                const tooltipContent = insights.length > 0 ? insights.join('<br>') : 'No specific insights available';

                                return (
                                    <tr key={index}>
                                        <td className="p-2 symbol-cell relative">
                                            {item.Symbol || ''}
                                            <div className="stock-tooltip">{tooltipContent}</div>
                                        </td>
                                        <td className="p-2">{pe.toFixed(2)}</td>
                                        <td className="p-2">{volumeTrend}</td>
                                        <td className="p-2 negative">{distHigh}%</td>
                                        <td className="p-2 positive">{distLow}%</td>
                                        <td className="p-2 ${getPLClass(change)}">{change.toFixed(2)}</td>
                                        <td className="p-2 ${getPLClass(changePct)}">{changePct.toFixed(2)}%</td>
                                        <td className="p-2">
                                            <PriceRangeChart
                                                low52={low52}
                                                price={price}
                                                high52={high52}
                                                index={index}
                                            />
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // Fetch Data and Render React Component
        async function fetchPortfolio() {
            const res = await fetch(SHEET_URL);
            if (!res.ok) throw new Error('Failed to fetch portfolio data');
            const data = await res.json();
            console.log('Portfolio data:', data);
            return data;
        }

        function calcInsights(data) {
            let best = null, worst = null;
            data.forEach(item => {
                if (!best || parseFloat(item['Profit/Loss']) > parseFloat(best['Profit/Loss'])) best = item;
                if (!worst || parseFloat(item['Profit/Loss']) < parseFloat(worst['Profit/Loss'])) worst = item;
            });
            const sectorMap = {};
            data.forEach(item => {
                const sector = item.Sector || 'Unknown';
                sectorMap[sector] = (sectorMap[sector] || 0) + (parseFloat(item['Current Value ']) || 0);
            });
            const topSector = Object.entries(sectorMap).sort((a, b) => b[1] - a[1])[0];
            return { best, worst, topSector };
        }

        function calcRiskMetrics(data) {
            const plValues = data.map(item => {
                const pl = parseFloat(item['Profit/Loss']);
                if (isNaN(pl)) console.warn(`Invalid Profit/Loss for ${item.Symbol}: ${item['Profit/Loss']}`);
                return pl;
            }).filter(v => !isNaN(v));

            let hasInvalidCV = false;
            const cvValues = data.map(item => {
                const cv = parseFloat(item['Current Value ']);
                if (isNaN(cv)) {
                    console.warn(`Invalid Current Value for ${item.Symbol}: ${item['Current Value ']}`);
                    hasInvalidCV = true;
                    return 10000;
                }
                return cv;
            });
            const totalValue = cvValues.reduce((sum, cv) => sum + cv, 0);

            let volatility = 0, beta = 0, volatilityCalc = '', betaCalc = '';

            if (plValues.length === 0) {
                console.warn(`Cannot calculate risk metrics: No valid Profit/Loss entries`);
                volatilityCalc = `Error: No valid Profit/Loss entries found. Please ensure 'Profit/Loss' in your Google Sheet contains numeric values (e.g., 5000).`;
                betaCalc = volatilityCalc;
            } else {
                const meanPL = plValues.reduce((sum, val) => sum + val, 0) / plValues.length;

                if (plValues.length >= 2) {
                    const variance = plValues.reduce((sum, val) => sum + Math.pow(val - meanPL, 2), 0) / plValues.length;
                    const stdDev = Math.sqrt(variance);
                    volatility = (stdDev / totalValue * 100) || 0;
                    volatilityCalc = `Volatility = (StdDev of P/L: â‚¹${stdDev.toFixed(2)} / Total Value: â‚¹${totalValue.toFixed(2)}) Ã— 100 = ${volatility.toFixed(2)}%; low volatility means your portfolio has minimal price swings, indicating low risk.`;
                    if (hasInvalidCV) {
                        volatilityCalc += `<br><strong>Warning:</strong> 'Current Value ' contains 'N/A'. Using fallback value of â‚¹10,000 per stock. Please update your Google Sheet with numeric values (e.g., 10000).`;
                    }
                } else {
                    volatilityCalc = `Volatility = 0%; only one P/L entry (${formatINR(plValues[0])}), so no variability to measure, assuming low risk.`;
                    if (hasInvalidCV) {
                        volatilityCalc += `<br><strong>Warning:</strong> 'Current Value ' contains 'N/A'. Using fallback value of â‚¹10,000 per stock. Please update your Google Sheet with numeric values (e.g., 10000).`;
                    }
                }

                beta = (Math.abs(meanPL) / totalValue * 10) || 0;
                betaCalc = `Beta = (|Mean P/L: â‚¹${meanPL.toFixed(2)}| / Total Value: â‚¹${totalValue.toFixed(2)}) Ã— 10 = ${beta.toFixed(2)}; a low beta means your portfolio is less volatile than the market.`;
                if (hasInvalidCV) {
                    betaCalc += `<br><strong>Warning:</strong> 'Current Value ' contains 'N/A'. Using fallback value of â‚¹10,000 per stock. Please update your Google Sheet with numeric values (e.g., 10000).`;
                }
            }

            return {
                volatility: volatility.toFixed(2),
                beta: beta.toFixed(2),
                volatilityCalc,
                betaCalc,
                hasInvalidCV
            };
        }

        function renderTopMetrics(totalInvested, totalValue, totalPL) {
            document.getElementById('topMetrics').innerHTML = `
            <div class="metric-card bg-white rounded-lg p-6 flex flex-col items-center">
                <span class="text-gray-500">Total Invested Value</span>
                <span class="text-2xl font-bold mt-2">${formatINR(totalInvested)}</span>
            </div>
            <div class="metric-card bg-white rounded-lg p-6 flex flex-col items-center">
                <span class="text-gray-500">Total Portfolio Value</span>
                <span class="text-2xl font-bold mt-2">${formatINR(totalValue)}</span>
            </div>
            <div class="metric-card bg-white rounded-lg p-6 flex flex-col items-center ${getPLClass(totalPL)}">
                <span class="text-gray-500">Total Profit/Loss</span>
                <span class="text-2xl font-bold mt-2">${formatINR(totalPL)}</span>
            </div>
        `;
        }

        function renderRiskMetrics(volatility, beta, volatilityCalc, betaCalc, hasInvalidCV) {
            const warning = hasInvalidCV
                ? `<div class="text-red-600 text-sm mt-2">Warning: Invalid data in 'Current Value '. Using fallback values. Check Google Sheet.</div>`
                : '';
            document.getElementById('riskMetrics').innerHTML = `
            <div class="metric-card bg-white rounded-lg p-6 flex flex-col items-center">
                <span class="text-gray-500">Portfolio Volatility</span>
                <span class="text-2xl font-bold mt-2">${volatility}%</span>
                <span class="text-sm text-gray-400">${volatility < 10 ? 'Low' : volatility < 20 ? 'Moderate' : 'High'} Risk</span>
                ${warning}
                <div class="tooltip">${volatilityCalc}</div>
            </div>
            <div class="metric-card bg-white rounded-lg p-6 flex flex-col items-center">
                <span class="text-gray-500">Portfolio Beta</span>
                <span class="text-2xl font-bold mt-2">${beta}</span>
                <span class="text-sm text-gray-400">${beta < 1 ? 'Less Volatile' : 'More Volatile'} than Market</span>
                ${warning}
                <div class="tooltip">${betaCalc}</div>
            </div>
        `;
        }

        function renderInvestmentsTable(data, sectorFilter = '', sortAsc = true) {
            let filteredData = data;
            if (sectorFilter) {
                filteredData = data.filter(item => (item['Sector '] || 'Unknown') === sectorFilter);
            }
            filteredData = filteredData.sort((a, b) => {
                const valA = parseFloat(a['Profit/Loss']) || 0;
                const valB = parseFloat(b['Profit/Loss']) || 0;
                return sortAsc ? valA - valB : valB - valA;
            });
            document.getElementById('investmentsTable').innerHTML = `
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2">Symbol</th>
                        <th class="p-2">Buy Price</th>
                        <th class="p-2">Current Price</th>
                        <th class="p-2">Quantity</th>
                        <th class="p-2">Total Investment</th>
                        <th class="p-2">Current Value</th>
                        <th class="p-2">Profit/Loss</th>
                        <th class="p-2">Sector</th>
                        <th class="p-2">Date</th>
                    </tr>
                </thead>
                <tbody id="investmentsBody">
                    ${filteredData.map(item => {
                const buyPrice = Number(item['Buy Price ']);
                const currentPrice = Number(item['Current Price']);
                const quantity = item['Quantity'] !== undefined && item['Quantity'] !== '' ? item['Quantity'] : '';
                const totalInvestment = Number(item['Total Investment']);
                const currentValue = Number(item['Current Value ']);
                const profitLoss = Number(item['Profit/Loss']);
                return `
                            <tr>
                                <td class="p-2">${item.Symbol || ''}</td>
                                <td class="p-2">${!isNaN(buyPrice) && buyPrice !== 0 ? formatINR(buyPrice) : ''}</td>
                                <td class="p-2">${!isNaN(currentPrice) && currentPrice !== 0 ? formatINR(currentPrice) : ''}</td>
                                <td class="p-2">${quantity}</td>
                                <td class="p-2">${!isNaN(totalInvestment) && totalInvestment !== 0 ? formatINR(totalInvestment) : ''}</td>
                                <td class="p-2">${!isNaN(currentValue) && currentValue !== 0 ? formatINR(currentValue) : ''}</td>
                                <td class="p-2 ${getPLClass(profitLoss)}">${!isNaN(profitLoss) && profitLoss !== 0 ? formatINR(profitLoss) : ''}</td>
                                <td class="p-2">${item['Sector '] || ''}</td>
                                <td class="p-2">${item.Date || ''}</td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
            `;
        }

        function populateSectorFilter(data) {
            const sectors = [...new Set(data.map(item => item['Sector '] || 'Unknown'))];
            const select = document.getElementById('sectorFilter');
            select.innerHTML = '<option value="">All Sectors</option>' +
                sectors.map(sector => `<option value="${sector}">${sector}</option>`).join('');
        }

        function renderInsights(insights) {
            document.getElementById('insights').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-gray-500 mb-1">Best Performer</div>
                    <div class="font-bold">${insights.best.Symbol}</div>
                    <div class="text-green-700">${formatINR(insights.best['Profit/Loss'])}</div>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="text-gray-500 mb-1">Worst Performer</div>
                    <div class="font-bold">${insights.worst.Symbol}</div>
                    <div class="text-red-700">${formatINR(insights.worst['Profit/Loss'])}</div>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="text-gray-500 mb-1">Top Sector</div>
                    <div class="font-bold">${insights.topSector[0]}</div>
                    <div class="text-blue-700">${formatINR(insights.topSector[1])}</div>
                </div>
            </div>
        `;
        }

        function renderStockPerformanceChart(data) {
            const ctx = document.getElementById('stockPerformanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(i => i.Symbol),
                    datasets: [{
                        label: 'Profit/Loss',
                        data: data.map(i => i['Profit/Loss']),
                        backgroundColor: data.map(i => parseFloat(i['Profit/Loss']) >= 0 ? '#34d399' : '#f87171'),
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => formatINR(v) } }
                    }
                }
            });
        }

        function renderSectorChart(data) {
            const ctx = document.getElementById('sectorChart').getContext('2d');
            const sectorMap = {};
            data.forEach(item => {
                const sector = item['Sector '] || 'Unknown';
                const currentValue = Number(item['Current Value ']) || 0;
                sectorMap[sector] = (sectorMap[sector] || 0) + currentValue;
            });
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(sectorMap),
                    datasets: [{
                        data: Object.values(sectorMap),
                        backgroundColor: ['#60a5fa', '#fbbf24', '#34d399', '#f87171', '#a78bfa', '#f472b6', '#facc15'],
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        async function main() {
            try {
                const data = await fetchPortfolio();
                const summary = data[0];
                const rows = data;
                const totalInvested = Number(summary['Total Invested Value ']) || 0;
                const totalValue = Number(summary['Total Portfolio Value ']) || 0;
                const totalPL = Number(summary['Total Profit/Loss']) || 0;
                renderTopMetrics(totalInvested, totalValue, totalPL);

                const riskMetrics = calcRiskMetrics(rows);
                renderRiskMetrics(riskMetrics.volatility, riskMetrics.beta, riskMetrics.volatilityCalc, riskMetrics.betaCalc, riskMetrics.hasInvalidCV);

                renderInvestmentsTable(rows);
                populateSectorFilter(rows);
                renderStockPerformanceChart(rows);
                renderSectorChart(rows);
                renderInsights(calcInsights(rows));

                // Render React Component
                const root = ReactDOM.createRoot(document.getElementById('stockAnalysisReact'));
                root.render(<StockAnalysis data={rows} />);

                let sortAsc = true;
                document.getElementById('sectorFilter').addEventListener('change', (e) => {
                    renderInvestmentsTable(rows, e.target.value, sortAsc);
                });
                document.getElementById('sortProfitLoss').addEventListener('click', () => {
                    sortAsc = !sortAsc;
                    renderInvestmentsTable(rows, document.getElementById('sectorFilter').value, sortAsc);
                    document.getElementById('sortProfitLoss').textContent = `Sort by Profit/Loss (${sortAsc ? 'Asc' : 'Desc'})`;
                });
            } catch (e) {
                document.body.innerHTML = `<div class='text-center text-red-600 mt-20'>Failed to load portfolio data.<br>${e.message}</div>`;
            }
        }
        main();

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkIcon = document.getElementById('darkIcon');
        const lightIcon = document.getElementById('lightIcon');
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
            Chart.helpers.each(Chart.instances, function (instance) {
                if (instance.options && instance.options.plugins && instance.options.plugins.legend) {
                    instance.options.plugins.legend.labels.color = enabled ? '#e0e7ef' : '#1f2937';
                }
                if (instance.options && instance.options.scales) {
                    Object.values(instance.options.scales).forEach(scale => {
                        if (scale.ticks) scale.ticks.color = enabled ? '#e0e7ef' : '#1f2937';
                    });
                }
                instance.update();
            });
        }
        darkModeToggle.addEventListener('click', () => {
            const enabled = !document.body.classList.contains('dark-mode');
            setDarkMode(enabled);
            localStorage.setItem('darkMode', enabled ? 'enabled' : 'disabled');
        });
        if (localStorage.getItem('darkMode') === 'enabled') {
            setDarkMode(true);
        }
    </script>
</body>

</html>
